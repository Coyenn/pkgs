name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: cachix/install-nix-action@v31
    - name: Check flake
      run: nix flake check
    - name: Build all packages
      run: |
        # Get all package names dynamically and build them
        packages=$(nix flake show --json | jq -r '.packages."x86_64-linux" | keys[]')
        build_args=""
        for pkg in $packages; do
          build_args="$build_args .#$pkg"
        done
        nix build $build_args
